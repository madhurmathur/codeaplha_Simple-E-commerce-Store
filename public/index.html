<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CodeAlpha E-commerce Store</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Roboto:wght@700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); color: #f0f0f0; line-height: 1.6; overflow-x: hidden; }
    .navbar { background: linear-gradient(90deg, #2c3e50, #3498db); padding: 1.5rem; color: white; text-align: center; font-family: 'Roboto', sans-serif; font-size: 2.2rem; font-weight: 700; position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.6); animation: fadeIn 1s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .cart-badge { background: #e74c3c; color: white; border-radius: 50%; padding: 6px 10px; font-size: 1.2rem; position: absolute; top: 15px; right: 30px; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    .auth { max-width: 450px; margin: 30px auto; padding: 25px; background: rgba(42, 42, 42, 0.9); border-radius: 15px; box-shadow: 0 6px 25px rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
    .auth input { width: 85%; padding: 12px; margin: 10px 0; border: 2px solid #555; border-radius: 8px; background: #2a2a2a; color: #f0f0f0; font-size: 1rem; transition: border-color 0.3s; }
    .auth input:focus { border-color: #3498db; outline: none; }
    .auth button { padding: 12px 25px; background: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1rem; transition: transform 0.3s, background 0.3s; }
    .auth button:hover { background: #c0392b; transform: translateY(-2px); }
    .products { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; padding: 40px; max-width: 1300px; margin: 0 auto; }
    .product { background: rgba(42, 42, 42, 0.95); border-radius: 15px; overflow: hidden; box-shadow: 0 6px 25px rgba(0,0,0,0.5); transition: transform 0.4s; }
    .product:hover { transform: translateY(-10px); }
    .product img { width: 100%; height: 280px; object-fit: cover; background: #333; transition: opacity 0.3s; }
    .product img:hover { opacity: 0.9; }
    .product-info { padding: 20px; text-align: center; }
    .product-info h3 { margin: 12px 0; color: #ecf0f1; font-size: 1.3rem; font-weight: 600; }
    .product-info p { color: #bdc3c7; font-size: 1.1rem; }
    .quantity-select { padding: 10px; width: 80px; margin: 10px 0; border: 2px solid #555; border-radius: 8px; background: #2a2a2a; color: #f0f0f0; font-size: 1rem; transition: border-color 0.3s; }
    .quantity-select:focus { border-color: #3498db; outline: none; }
    .product-info button { padding: 12px 25px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1rem; transition: transform 0.3s, background 0.3s; }
    .product-info button:hover { background: #2980b9; transform: translateY(-2px); }
    .product-info button:disabled { background: #7f8c8d; cursor: not-allowed; }
    .cart { max-width: 1300px; margin: 30px auto; padding: 25px; background: rgba(42, 42, 42, 0.9); border-radius: 15px; box-shadow: 0 6px 25px rgba(0,0,0,0.5); display: none; animation: slideUp 0.5s ease-out; }
    .cart.active { display: block; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .cart-item { display: flex; justify-content: space-between; padding: 15px; border-bottom: 2px solid #555; animation: fadeIn 0.5s ease-in; }
    .cart-item button { background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: transform 0.3s, background 0.3s; }
    .cart-item button:hover { background: #c0392b; transform: translateY(-2px); }
    .product-details { max-width: 650px; margin: 30px auto; padding: 25px; background: rgba(42, 42, 42, 0.9); border-radius: 15px; box-shadow: 0 6px 25px rgba(0,0,0,0.5); display: none; animation: slideUp 0.5s ease-out; }
    .product-details.active { display: block; }
    .product-details img { width: 100%; height: auto; background: #333; }
    .product-details button { padding: 12px 25px; background: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.3s, background 0.3s; margin: 5px; }
    .product-details button:hover { background: #c0392b; transform: translateY(-2px); }
    .search-bar { max-width: 1300px; margin: 20px auto; padding: 15px; position: relative; }
    .search-bar input { width: 70%; padding: 12px; border: 2px solid #555; border-radius: 8px; background: #2a2a2a; color: #f0f0f0; font-size: 1.1rem; transition: border-color 0.3s; }
    .search-bar input:focus { border-color: #3498db; outline: none; }
    .search-suggestions { position: absolute; top: 100%; left: 0; width: 70%; background: #2a2a2a; border: 2px solid #555; border-radius: 8px; max-height: 250px; overflow-y: auto; display: none; z-index: 10; animation: fadeIn 0.3s ease-in; }
    .search-suggestions.active { display: block; }
    .search-suggestion { padding: 12px; cursor: pointer; transition: background 0.3s; }
    .search-suggestion:hover { background: #333; }
    .search-bar button { padding: 12px 25px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.3s, background 0.3s; }
    .search-bar button:hover { background: #2980b9; transform: translateY(-2px); }
    .add-to-cart-animation { animation: bounce 0.5s ease-out; }
    .remove-from-cart-animation { animation: shake 0.5s ease-out; }
    .login-success-animation { animation: glow 1s ease-out; }
    .register-success-animation { animation: pulse 1s ease-out; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    @keyframes glow { 0% { box-shadow: 0 0 5px #3498db; } 50% { box-shadow: 0 0 20px #3498db; } 100% { box-shadow: 0 0 5px #3498db; } }
    @media (max-width: 600px) {
      .products { grid-template-columns: 1fr; padding: 20px; }
      .auth { margin: 15px; }
      .product-details { margin: 15px; }
      .search-bar input { width: 60%; }
      .search-suggestions { width: 60%; }
      .navbar { font-size: 1.7rem; padding: 1rem; }
    }
  </style>
</head>
<body>
  <div class="navbar">CodeAlpha E-commerce Store<span class="cart-badge" id="cart-badge">0</span></div>
  <div class="search-bar">
    <input type="text" id="search-input" placeholder="Search for products..." oninput="showSuggestions()">
    <div class="search-suggestions" id="search-suggestions"></div>
    <button onclick="searchProducts()">Search</button>
  </div>
  <div class="auth">
    <h2>Login/Register</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button onclick="register()">Register</button>
    <button onclick="login()">Login</button>
    <p id="auth-message"></p>
  </div>

  <div class="products" id="products"></div>

  <div class="cart" id="cart">
    <h2>Your Cart</h2>
    <div id="cart-items"></div>
    <p>Total: $<span id="cart-total">0</span></p>
    <button onclick="placeOrder()">Place Order</button>
  </div>

  <div class="product-details" id="product-details">
    <h2>Product Details</h2>
    <div id="detail-content"></div>
    <button onclick="addToCartFromDetails()">Add to Cart</button>
    <button onclick="hideDetails()">Back</button>
  </div>

  <script>
    let isLoggedIn = false;
    let currentUser = null;
    let selectedProduct = null;

    async function loadProducts() {
      try {
        const res = await fetch('/api/products');
        const products = await res.json();
        const productsDiv = document.getElementById('products');
        productsDiv.innerHTML = products.map(p => `
          <div class="product" onclick="viewProduct(${p.id})" style="cursor: pointer;">
            <img src="https://picsum.photos/200" alt="${p.name}" onerror="this.onerror=null; this.src='https://picsum.photos/200';">
            <div class="product-info">
              <h3>${p.name}</h3>
              <p>$${p.price.toFixed(2)}</p>
              <input type="number" class="quantity-select" id="quantity-${p.id}" value="1" min="1" onchange="validateQuantity(${p.id})">
              <button onclick="addToCart(${p.id}, document.getElementById('quantity-${p.id}').value); event.stopPropagation();" ${!isLoggedIn ? 'disabled' : ''}>Add to Cart</button>
            </div>
          </div>
        `).join('');
        updateCartBadge();
      } catch (error) {
        console.error('Error loading products:', error);
        alert('Failed to load products. Check the server.');
      }
    }

    function validateQuantity(productId) {
      const input = document.getElementById(`quantity-${productId}`);
      if (input.value < 1) input.value = 1;
    }

    async function viewProduct(id) {
      try {
        const res = await fetch(`/api/products/${id}`);
        const product = await res.json();
        selectedProduct = product;
        document.getElementById('detail-content').innerHTML = `
          <img src="https://picsum.photos/200" alt="${product.name}" onerror="this.onerror=null; this.src='https://picsum.photos/200';">
          <h3>${product.name}</h3>
          <p>$${product.price.toFixed(2)}</p>
          <p>${product.description}</p>
          <input type="number" class="quantity-select" id="detail-quantity" value="1" min="1" onchange="validateQuantity(${id})">
        `;
        document.getElementById('product-details').classList.add('active');
      } catch (error) {
        console.error('Error viewing product:', error);
      }
    }

    function hideDetails() {
      document.getElementById('product-details').classList.remove('active');
    }

    async function addToCart(productId, quantity) {
      if (!isLoggedIn) {
        alert('Please log in first');
        return;
      }
      quantity = parseInt(quantity);
      if (isNaN(quantity) || quantity < 1) quantity = 1;
      const button = event.target;
      button.classList.add('add-to-cart-animation');
      try {
        const res = await fetch('/api/cart', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId, quantity })
        });
        const data = await res.json();
        if (res.ok && data.message === 'Added to cart') {
          loadCart();
          alert('Item added to cart!');
        } else {
          alert('Failed to add to cart: ' + (data.message || 'Server error'));
        }
      } catch (error) {
        console.error('Error adding to cart:', error);
        alert('An error occurred. Check the console.');
      } finally {
        setTimeout(() => button.classList.remove('add-to-cart-animation'), 500);
      }
    }

    async function addToCartFromDetails() {
      if (!isLoggedIn) {
        alert('Please log in first');
        return;
      }
      if (selectedProduct) {
        const quantity = document.getElementById('detail-quantity').value;
        await addToCart(selectedProduct.id, quantity);
        hideDetails();
      }
    }

    async function loadCart() {
      try {
        const res = await fetch('/api/cart');
        const cart = await res.json();
        const cartItemsDiv = document.getElementById('cart-items');
        cartItemsDiv.innerHTML = cart.map(item => `
          <div class="cart-item">
            <span>${item.name} - $${(item.price * item.quantity).toFixed(2)} x ${item.quantity}</span>
            <button onclick="removeFromCart(${item.id}); event.stopPropagation();" class="remove-from-cart-animation">Remove</button>
          </div>
        `).join('');
        document.getElementById('cart-total').textContent = cart.reduce((sum, item) => sum + item.price * item.quantity, 0).toFixed(2);
        document.getElementById('cart').classList.add('active');
        updateCartBadge();
      } catch (error) {
        console.error('Error loading cart:', error);
      }
    }

    async function removeFromCart(productId) {
      const button = event.target;
      button.classList.add('remove-from-cart-animation');
      try {
        const res = await fetch(`/api/cart/${productId}`, { method: 'DELETE' });
        const data = await res.json();
        if (res.ok && data.message === 'Removed from cart') {
          loadCart();
        } else {
          alert('Failed to remove from cart: ' + (data.message || 'Server error'));
        }
      } catch (error) {
        console.error('Error removing from cart:', error);
      } finally {
        setTimeout(() => button.classList.remove('remove-from-cart-animation'), 500);
      }
    }

    async function placeOrder() {
      if (!isLoggedIn) {
        alert('Please log in first');
        return;
      }
      try {
        const res = await fetch('/api/orders', { method: 'POST' });
        const data = await res.json();
        if (res.ok && data.message === 'Order placed') {
          alert('Order placed successfully!');
          document.getElementById('cart').classList.remove('active');
          loadCart();
        }
      } catch (error) {
        console.error('Error placing order:', error);
      }
    }

    async function register() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      try {
        const res = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        const authMessage = document.getElementById('auth-message');
        authMessage.textContent = data.message;
        if (res.ok && data.message === 'User registered') {
          authMessage.classList.add('register-success-animation');
          setTimeout(() => authMessage.classList.remove('register-success-animation'), 1000);
        }
      } catch (error) {
        console.error('Error registering:', error);
      }
    }

    async function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        const authMessage = document.getElementById('auth-message');
        if (res.ok && data.message === 'Login successful') {
          isLoggedIn = true;
          currentUser = data.user;
          authMessage.textContent = data.message;
          authMessage.classList.add('login-success-animation');
          setTimeout(() => {
            authMessage.classList.remove('login-success-animation');
            loadProducts();
          }, 1000);
        } else {
          authMessage.textContent = data.message || 'Login failed';
        }
      } catch (error) {
        console.error('Error logging in:', error);
        document.getElementById('auth-message').textContent = 'An error occurred';
      }
    }

    function searchProducts() {
      const query = document.getElementById('search-input').value.toLowerCase();
      const productsDiv = document.getElementById('products');
      fetch('/api/products')
        .then(res => res.json())
        .then(products => {
          const filteredProducts = products.filter(p => p.name.toLowerCase().includes(query));
          productsDiv.innerHTML = filteredProducts.map(p => `
            <div class="product" onclick="viewProduct(${p.id})" style="cursor: pointer;">
              <img src="https://picsum.photos/200" alt="${p.name}" onerror="this.onerror=null; this.src='https://picsum.photos/200';">
              <div class="product-info">
                <h3>${p.name}</h3>
                <p>$${p.price.toFixed(2)}</p>
                <input type="number" class="quantity-select" id="quantity-${p.id}" value="1" min="1" onchange="validateQuantity(${p.id})">
                <button onclick="addToCart(${p.id}, document.getElementById('quantity-${p.id}').value); event.stopPropagation();" ${!isLoggedIn ? 'disabled' : ''}>Add to Cart</button>
              </div>
            </div>
          `).join('');
        })
        .catch(error => {
          console.error('Error searching products:', error);
          alert('Failed to search products.');
        });
    }

    function showSuggestions() {
      const query = document.getElementById('search-input').value.toLowerCase();
      const suggestionsDiv = document.getElementById('search-suggestions');
      if (query.length < 2) {
        suggestionsDiv.classList.remove('active');
        return;
      }
      fetch('/api/products')
        .then(res => res.json())
        .then(products => {
          const filtered = products.filter(p => p.name.toLowerCase().includes(query)).slice(0, 5);
          suggestionsDiv.innerHTML = filtered.map(p => `
            <div class="search-suggestion" onclick="selectSuggestion('${p.name}')">${p.name}</div>
          `).join('');
          suggestionsDiv.classList.add('active');
        })
        .catch(error => console.error('Error fetching suggestions:', error));
    }

    function selectSuggestion(name) {
      document.getElementById('search-input').value = name;
      document.getElementById('search-suggestions').classList.remove('active');
      searchProducts();
    }

    function updateCartBadge() {
      fetch('/api/cart')
        .then(res => res.json())
        .then(cart => {
          document.getElementById('cart-badge').textContent = cart.length;
        })
        .catch(error => console.error('Error updating cart badge:', error));
    }

    window.onload = loadProducts;
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-bar')) {
        document.getElementById('search-suggestions').classList.remove('active');
      }
    });
  </script>
</body>
</html>